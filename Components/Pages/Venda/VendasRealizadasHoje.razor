@page "/venda/realizadas"
@rendermode InteractiveServer

<PageTitle>Vendas Realizadas Hoje - Sistema de Faturação</PageTitle>

<div class="d-flex justify-space-between align-center mb-6">
    <div>
        <MudText Typo="Typo.h4">Vendas Realizadas Hoje</MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary">@DateTime.Now.ToString("dd/MM/yyyy")</MudText>
    </div>
    <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.FileDownload" OnClick="ExportarVendas">
        Exportar
    </MudButton>
</div>

<!-- Estatísticas Rápidas -->
<MudGrid Class="mb-6">
    <MudItem xs="12" sm="6" md="3">
        <MudPaper Elevation="2" Class="pa-4">
            <div class="d-flex justify-space-between align-center">
                <div>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Total de Vendas</MudText>
                    <MudText Typo="Typo.h4">@totalVendas</MudText>
                </div>
                <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" Size="Size.Large" Color="Color.Primary" />
            </div>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" sm="6" md="3">
        <MudPaper Elevation="2" Class="pa-4">
            <div class="d-flex justify-space-between align-center">
                <div>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Valor Total</MudText>
                    <MudText Typo="Typo.h4" Color="Color.Success">@($"{valorTotal:N2} €")</MudText>
                </div>
                <MudIcon Icon="@Icons.Material.Filled.EuroSymbol" Size="Size.Large" Color="Color.Success" />
            </div>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" sm="6" md="3">
        <MudPaper Elevation="2" Class="pa-4">
            <div class="d-flex justify-space-between align-center">
                <div>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Ticket Médio</MudText>
                    <MudText Typo="Typo.h4" Color="Color.Info">@($"{ticketMedio:N2} €")</MudText>
                </div>
                <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Size="Size.Large" Color="Color.Info" />
            </div>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" sm="6" md="3">
        <MudPaper Elevation="2" Class="pa-4">
            <div class="d-flex justify-space-between align-center">
                <div>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Produtos Vendidos</MudText>
                    <MudText Typo="Typo.h4" Color="Color.Warning">@produtosVendidos</MudText>
                </div>
                <MudIcon Icon="@Icons.Material.Filled.Inventory" Size="Size.Large" Color="Color.Warning" />
            </div>
        </MudPaper>
    </MudItem>
</MudGrid>

<MudPaper Elevation="2" Class="pa-6">
    <!-- Filtros Rápidos -->
    <MudButtonGroup Class="mb-6" Color="Color.Primary" Variant="Variant.Outlined">
        <MudButton OnClick="@(() => FiltrarPorStatus(null))" Variant="@(statusFiltro == null ? Variant.Filled : Variant.Outlined)">
            Todas
        </MudButton>
        <MudButton OnClick="@(() => FiltrarPorStatus("pago"))" Variant="@(statusFiltro == "pago" ? Variant.Filled : Variant.Outlined)">
            Pagas
        </MudButton>
        <MudButton OnClick="@(() => FiltrarPorStatus("pendente"))" Variant="@(statusFiltro == "pendente" ? Variant.Filled : Variant.Outlined)">
            Pendentes
        </MudButton>
    </MudButtonGroup>

    <!-- Tabela de Vendas -->
    <MudTable Items="@vendasFiltradas" Hover="true" Breakpoint="Breakpoint.Sm" Dense="true">
        <HeaderContent>
            <MudTh>Hora</MudTh>
            <MudTh>Cliente</MudTh>
            <MudTh>Produtos</MudTh>
            <MudTh>Total</MudTh>
            <MudTh>Pagamento</MudTh>
            <MudTh>Status</MudTh>
            <MudTh>Ações</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Hora">@context.Hora.ToString("HH:mm")</MudTd>
            <MudTd DataLabel="Cliente">@context.Cliente</MudTd>
            <MudTd DataLabel="Produtos">@context.QuantidadeProdutos itens</MudTd>
            <MudTd DataLabel="Total"><strong>@context.Total.ToString("N2") €</strong></MudTd>
            <MudTd DataLabel="Pagamento">@context.FormaPagamento</MudTd>
            <MudTd DataLabel="Status">
                @if (context.Status == "pago")
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Success">Pago</MudChip>
                }
                else
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Warning">Pendente</MudChip>
                }
            </MudTd>
            <MudTd DataLabel="Ações">
                <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" Color="Color.Info" OnClick="@(() => VisualizarDetalhes(context.Id))" />
                <MudIconButton Icon="@Icons.Material.Filled.Print" Size="Size.Small" OnClick="@(() => ImprimirRecibo(context.Id))" />
                <MudIconButton Icon="@Icons.Material.Filled.Cancel" Size="Size.Small" Color="Color.Error" OnClick="@(() => CancelarVenda(context.Id))" />
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText Typo="Typo.body1" Align="Align.Center" Class="py-8">
                <MudIcon Icon="@Icons.Material.Filled.Inbox" Size="Size.Large" Class="mb-2" />
                <br />
                Nenhuma venda realizada hoje
            </MudText>
        </NoRecordsContent>
    </MudTable>
</MudPaper>

@code {
    private List<VendaRealizadaDto> vendas = new();
    private List<VendaRealizadaDto> vendasFiltradas = new();
    private string? statusFiltro = null;
    private int totalVendas = 0;
    private decimal valorTotal = 0;
    private decimal ticketMedio = 0;
    private int produtosVendidos = 0;

    protected override void OnInitialized()
    {
        CarregarVendas();
    }

    private void CarregarVendas()
    {
        // Exemplo de dados
        vendas = new List<VendaRealizadaDto>
        {
            new VendaRealizadaDto { Id = 1, Hora = DateTime.Now.AddHours(-2), Cliente = "João Silva", QuantidadeProdutos = 3, Total = 150.00m, FormaPagamento = "Dinheiro", Status = "pago" },
            new VendaRealizadaDto { Id = 2, Hora = DateTime.Now.AddHours(-1), Cliente = "Maria Santos", QuantidadeProdutos = 5, Total = 320.00m, FormaPagamento = "Cartão", Status = "pago" }
        };
        
        vendasFiltradas = vendas;
        CalcularEstatisticas();
    }

    private void FiltrarPorStatus(string? status)
    {
        statusFiltro = status;
        vendasFiltradas = status == null 
            ? vendas 
            : vendas.Where(v => v.Status == status).ToList();
        CalcularEstatisticas();
    }

    private void CalcularEstatisticas()
    {
        totalVendas = vendasFiltradas.Count;
        valorTotal = vendasFiltradas.Sum(v => v.Total);
        ticketMedio = totalVendas > 0 ? valorTotal / totalVendas : 0;
        produtosVendidos = vendasFiltradas.Sum(v => v.QuantidadeProdutos);
    }

    private void VisualizarDetalhes(int vendaId) { }
    private void ImprimirRecibo(int vendaId) { }
    private void CancelarVenda(int vendaId) { }
    private void ExportarVendas() { }

    public class VendaRealizadaDto
    {
        public int Id { get; set; }
        public DateTime Hora { get; set; }
        public string Cliente { get; set; } = "";
        public int QuantidadeProdutos { get; set; }
        public decimal Total { get; set; }
        public string FormaPagamento { get; set; } = "";
        public string Status { get; set; } = "";
    }
}

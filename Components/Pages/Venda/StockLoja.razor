@page "/venda/stock-loja"
@rendermode InteractiveServer

<PageTitle>Gestão de Stock Loja - Sistema de Faturação</PageTitle>

<div class="d-flex justify-space-between align-center mb-6">
    <div>
        <MudText Typo="Typo.h4">Gestão de Stock - Loja</MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary">Controle de estoque da loja</MudText>
    </div>
    <div class="d-flex gap-2">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Balance" OnClick="AjusteStock">
            Ajuste de Stock
        </MudButton>
        <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.SwapHoriz" OnClick="TransferirParaArmazem">
            Transferir
        </MudButton>
    </div>
</div>

<!-- Alertas de Stock -->
<MudGrid Class="mb-6">
    <MudItem xs="12" md="4">
        <MudAlert Severity="Severity.Error" Icon="@Icons.Material.Filled.Warning">
            <strong>Stock Crítico</strong><br/>5 produtos abaixo do mínimo
        </MudAlert>
    </MudItem>
    <MudItem xs="12" md="4">
        <MudAlert Severity="Severity.Warning" Icon="@Icons.Material.Filled.Info">
            <strong>Stock Baixo</strong><br/>12 produtos próximos do mínimo
        </MudAlert>
    </MudItem>
    <MudItem xs="12" md="4">
        <MudAlert Severity="Severity.Success" Icon="@Icons.Material.Filled.CheckCircle">
            <strong>Stock Normal</strong><br/>82 produtos em estoque adequado
        </MudAlert>
    </MudItem>
</MudGrid>

<MudPaper Elevation="2" Class="pa-6">
    <!-- Filtros -->
    <MudGrid Class="mb-6">
        <MudItem xs="12" sm="6" md="3">
            <MudTextField @bind-Value="searchTerm" Label="Pesquisar Produto" Placeholder="Nome ou código..." Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudSelect @bind-Value="categoriaSelecionada" Label="Categoria" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                <MudSelectItem Value="@("")">Todas</MudSelectItem>
                <MudSelectItem Value="@("1")">Eletrônicos</MudSelectItem>
                <MudSelectItem Value="@("2")">Alimentos</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudSelect @bind-Value="situacaoStock" Label="Situação Stock" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                <MudSelectItem Value="@("")">Todos</MudSelectItem>
                <MudSelectItem Value="@("critico")">Crítico</MudSelectItem>
                <MudSelectItem Value="@("baixo")">Baixo</MudSelectItem>
                <MudSelectItem Value="@("normal")">Normal</MudSelectItem>
                <MudSelectItem Value="@("excesso")">Excesso</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="6" md="3" Class="d-flex align-end">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" OnClick="Filtrar">
                Filtrar
            </MudButton>
        </MudItem>
    </MudGrid>

    <!-- Tabela de Stock -->
    <MudTable Items="@produtosStock" Hover="true" Breakpoint="Breakpoint.Sm" Dense="true">
        <HeaderContent>
            <MudTh>Código</MudTh>
            <MudTh>Produto</MudTh>
            <MudTh>Categoria</MudTh>
            <MudTh>Stock Atual</MudTh>
            <MudTh>Stock Mín.</MudTh>
            <MudTh>Stock Máx.</MudTh>
            <MudTh>Situação</MudTh>
            <MudTh>Ações</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Código"><code>@context.Codigo</code></MudTd>
            <MudTd DataLabel="Produto"><strong>@context.Nome</strong></MudTd>
            <MudTd DataLabel="Categoria">@context.Categoria</MudTd>
            <MudTd DataLabel="Stock Atual">
                <MudText Typo="Typo.body1" Color="@GetStockColor(context)"><strong>@context.StockAtual</strong></MudText>
            </MudTd>
            <MudTd DataLabel="Stock Mín.">@context.StockMinimo</MudTd>
            <MudTd DataLabel="Stock Máx.">@context.StockMaximo</MudTd>
            <MudTd DataLabel="Situação">
                @{
                    var status = GetStockStatus(context);
                    var color = status == "critico" ? Color.Error : (status == "baixo" ? Color.Warning : Color.Success);
                    var text = status == "critico" ? "Crítico" : (status == "baixo" ? "Baixo" : "Normal");
                }
                <MudChip T="string" Size="Size.Small" Color="@color">@text</MudChip>
            </MudTd>
            <MudTd DataLabel="Ações">
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Info" OnClick="@(() => AjustarStock(context.Id))" />
                <MudIconButton Icon="@Icons.Material.Filled.History" Size="Size.Small" OnClick="@(() => VerHistorico(context.Id))" />
            </MudTd>
        </RowTemplate>
    </MudTable>
</MudPaper>

@code {
    private string searchTerm = "";
    private string categoriaSelecionada = "";
    private string situacaoStock = "";
    private List<StockProdutoDto> produtosStock = new();

    protected override void OnInitialized()
    {
        CarregarStock();
    }

    private void CarregarStock()
    {
        produtosStock = new List<StockProdutoDto>
        {
            new StockProdutoDto { Id = 1, Codigo = "P001", Nome = "Produto A", Categoria = "Eletrônicos", StockAtual = 5, StockMinimo = 10, StockMaximo = 50 },
            new StockProdutoDto { Id = 2, Codigo = "P002", Nome = "Produto B", Categoria = "Alimentos", StockAtual = 25, StockMinimo = 15, StockMaximo = 100 },
            new StockProdutoDto { Id = 3, Codigo = "P003", Nome = "Produto C", Categoria = "Eletrônicos", StockAtual = 12, StockMinimo = 10, StockMaximo = 40 }
        };
    }

    private Color GetStockColor(StockProdutoDto item)
    {
        if (item.StockAtual <= item.StockMinimo) return Color.Error;
        if (item.StockAtual <= item.StockMinimo * 1.5) return Color.Warning;
        return Color.Success;
    }

    private string GetStockStatus(StockProdutoDto item)
    {
        if (item.StockAtual <= item.StockMinimo) return "critico";
        if (item.StockAtual <= item.StockMinimo * 1.5) return "baixo";
        return "normal";
    }

    private void Filtrar() { }
    private void AjusteStock() { }
    private void TransferirParaArmazem() { }
    private void AjustarStock(int id) { }
    private void VerHistorico(int id) { }

    public class StockProdutoDto
    {
        public int Id { get; set; }
        public string Codigo { get; set; } = "";
        public string Nome { get; set; } = "";
        public string Categoria { get; set; } = "";
        public int StockAtual { get; set; }
        public int StockMinimo { get; set; }
        public int StockMaximo { get; set; }
    }
}

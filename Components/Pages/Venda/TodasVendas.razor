@page "/venda/todas"
@rendermode InteractiveServer
@using BillingSystem.Components.Shared

<PageTitle>Todas as Vendas - Sistema de Faturação</PageTitle>

<div class="p-6 bg-gray-50 min-h-screen">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Todas as Vendas</h1>
        <p class="text-gray-600">Histórico completo de vendas do sistema</p>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
        <!-- Filtros Avançados -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Período</label>
                <select @bind="periodoSelecionado" @bind:after="AplicarFiltros" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                    <option value="hoje">Hoje</option>
                    <option value="semana">Esta Semana</option>
                    <option value="mes">Este Mês</option>
                    <option value="trimestre">Último Trimestre</option>
                    <option value="ano">Este Ano</option>
                    <option value="personalizado">Personalizado</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Cliente</label>
                <select @bind="clienteSelecionado" @bind:after="AplicarFiltros" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                    <option value="">Todos os Clientes</option>
                    <option value="1">João Silva</option>
                    <option value="2">Maria Santos</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                <select @bind="statusSelecionado" @bind:after="AplicarFiltros" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                    <option value="">Todos</option>
                    <option value="pago">Pago</option>
                    <option value="pendente">Pendente</option>
                    <option value="cancelado">Cancelado</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Forma de Pagamento</label>
                <select @bind="pagamentoSelecionado" @bind:after="AplicarFiltros" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                    <option value="">Todas</option>
                    <option value="dinheiro">Dinheiro</option>
                    <option value="cartao">Cartão</option>
                    <option value="transferencia">Transferência</option>
                    <option value="multicaixa">Multicaixa</option>
                </select>
            </div>
        </div>

        <!-- Estatísticas do Período -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6 p-4 bg-gradient-to-r from-orange-50 to-orange-100 rounded-lg">
            <div>
                <p class="text-xs text-gray-600 mb-1">Total Vendas</p>
                <p class="text-2xl font-bold text-gray-800">@vendasFiltradas.Count</p>
            </div>
            <div>
                <p class="text-xs text-gray-600 mb-1">Valor Total</p>
                <p class="text-2xl font-bold text-green-600">@vendasFiltradas.Sum(v => v.Total).ToString("N2") €</p>
            </div>
            <div>
                <p class="text-xs text-gray-600 mb-1">Pagas</p>
                <p class="text-2xl font-bold text-green-600">@vendasFiltradas.Count(v => v.Status == "pago")</p>
            </div>
            <div>
                <p class="text-xs text-gray-600 mb-1">Pendentes</p>
                <p class="text-2xl font-bold text-yellow-600">@vendasFiltradas.Count(v => v.Status == "pendente")</p>
            </div>
            <div>
                <p class="text-xs text-gray-600 mb-1">Canceladas</p>
                <p class="text-2xl font-bold text-red-600">@vendasFiltradas.Count(v => v.Status == "cancelado")</p>
            </div>
        </div>

        <!-- Tabela de Vendas -->
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                    <tr>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">ID</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Data/Hora</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Cliente</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Total</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Pagamento</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Usuário</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    @if (vendasFiltradas.Count == 0)
                    {
                        <EmptyState Colspan="8" 
                                    Message="Nenhuma venda encontrada com os filtros selecionados" 
                                    Icon="fa-solid fa-search" />
                    }
                    else
                    {
                        @foreach (var venda in vendasPaginadas)
                        {
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="px-4 py-3 text-sm font-mono">#@venda.Id.ToString("D5")</td>
                                <td class="px-4 py-3 text-sm">
                                    <div>@venda.Data.ToString("dd/MM/yyyy")</div>
                                    <div class="text-xs text-gray-500">@venda.Data.ToString("HH:mm")</div>
                                </td>
                                <td class="px-4 py-3 text-sm font-medium">@venda.Cliente</td>
                                <td class="px-4 py-3 text-sm font-bold">@venda.Total.ToString("N2") €</td>
                                <td class="px-4 py-3 text-sm">@venda.FormaPagamento</td>
                                <td class="px-4 py-3">
                                    <StatusBadge Status="@venda.Status" />
                                </td>
                                <td class="px-4 py-3 text-sm">@venda.Usuario</td>
                                <td class="px-4 py-3">
                                    <div class="flex gap-2">
                                        <IconButton Icon="fa-solid fa-eye" 
                                                    ColorScheme="blue" 
                                                    Title="Detalhes" 
                                                    OnClick="@(() => VisualizarDetalhes(venda.Id))" />
                                        <IconButton Icon="fa-solid fa-print" 
                                                    ColorScheme="gray" 
                                                    Title="Imprimir" 
                                                    OnClick="@(() => ImprimirVenda(venda.Id))" />
                                        <IconButton Icon="fa-solid fa-copy" 
                                                    ColorScheme="green" 
                                                    Title="Duplicar" 
                                                    OnClick="@(() => DuplicarVenda(venda.Id))" />
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        <!-- Paginação -->
        <div class="flex justify-between items-center mt-6">
            <div class="text-sm text-gray-600">
                Mostrando @((paginaAtual - 1) * itensPorPagina + 1) a @Math.Min(paginaAtual * itensPorPagina, vendasFiltradas.Count) de @vendasFiltradas.Count registros
            </div>
            <div class="flex gap-2">
                <button @onclick="PaginaAnterior" disabled="@(paginaAtual == 1)" class="px-4 py-2 border rounded-lg disabled:opacity-50">
                    Anterior
                </button>
                <button @onclick="ProximaPagina" disabled="@(paginaAtual >= totalPaginas)" class="px-4 py-2 border rounded-lg disabled:opacity-50">
                    Próxima
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    private List<VendaDto> todasVendas = new();
    private List<VendaDto> vendasFiltradas = new();
    private List<VendaDto> vendasPaginadas = new();
    
    private string periodoSelecionado = "mes";
    private string clienteSelecionado = "";
    private string statusSelecionado = "";
    private string pagamentoSelecionado = "";
    
    private int paginaAtual = 1;
    private int itensPorPagina = 15;
    private int totalPaginas => (int)Math.Ceiling((double)vendasFiltradas.Count / itensPorPagina);

    protected override void OnInitialized()
    {
        CarregarVendas();
        AplicarFiltros();
    }

    private void CarregarVendas()
    {
        // Exemplo de dados
        todasVendas = new List<VendaDto>
        {
            new VendaDto { Id = 1, Data = DateTime.Now.AddDays(-2), Cliente = "João Silva", Total = 450.00m, FormaPagamento = "Dinheiro", Status = "pago", Usuario = "Dalton Luís" },
            new VendaDto { Id = 2, Data = DateTime.Now.AddDays(-1), Cliente = "Maria Santos", Total = 820.00m, FormaPagamento = "Cartão", Status = "pago", Usuario = "Dalton Luís" },
            new VendaDto { Id = 3, Data = DateTime.Now, Cliente = "Pedro Costa", Total = 350.00m, FormaPagamento = "Transferência", Status = "pendente", Usuario = "Dalton Luís" }
        };
    }

    private void AplicarFiltros()
    {
        vendasFiltradas = todasVendas.Where(v =>
            (string.IsNullOrEmpty(clienteSelecionado) || v.Cliente.Contains(clienteSelecionado)) &&
            (string.IsNullOrEmpty(statusSelecionado) || v.Status == statusSelecionado) &&
            (string.IsNullOrEmpty(pagamentoSelecionado) || v.FormaPagamento.ToLower().Contains(pagamentoSelecionado))
        ).ToList();
        
        paginaAtual = 1;
        AtualizarPaginacao();
    }

    private void AtualizarPaginacao()
    {
        vendasPaginadas = vendasFiltradas
            .Skip((paginaAtual - 1) * itensPorPagina)
            .Take(itensPorPagina)
            .ToList();
    }

    private void PaginaAnterior()
    {
        if (paginaAtual > 1)
        {
            paginaAtual--;
            AtualizarPaginacao();
        }
    }

    private void ProximaPagina()
    {
        if (paginaAtual < totalPaginas)
        {
            paginaAtual++;
            AtualizarPaginacao();
        }
    }

    private void VisualizarDetalhes(int vendaId) { }
    private void ImprimirVenda(int vendaId) { }
    private void DuplicarVenda(int vendaId) { }

    public class VendaDto
    {
        public int Id { get; set; }
        public DateTime Data { get; set; }
        public string Cliente { get; set; } = "";
        public decimal Total { get; set; }
        public string FormaPagamento { get; set; } = "";
        public string Status { get; set; } = "";
        public string Usuario { get; set; } = "";
    }
}

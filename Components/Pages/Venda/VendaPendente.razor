@page "/venda/pendente"
@rendermode InteractiveServer

<PageTitle>Vendas Pendentes - Sistema de Faturação</PageTitle>

<MudText Typo="Typo.h4" Class="mb-2">Vendas Pendentes</MudText>
<MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-6">Gerencie vendas com pagamento pendente</MudText>

<MudPaper Elevation="2" Class="pa-6">
    <!-- Filtros -->
    <MudGrid Class="mb-6">
        <MudItem xs="12" sm="6" md="3">
            <MudTextField @bind-Value="searchTerm" Label="Pesquisar" Placeholder="Cliente, produto..." Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudDatePicker @bind-Date="dataInicial" Label="Data Inicial" Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudDatePicker @bind-Date="dataFinal" Label="Data Final" Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" sm="6" md="3" Class="d-flex align-end">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" StartIcon="@Icons.Material.Filled.FilterList" OnClick="Filtrar">
                Filtrar
            </MudButton>
        </MudItem>
    </MudGrid>

    <!-- Tabela -->
    <MudTable Items="@vendasPendentes" Hover="true" Breakpoint="Breakpoint.Sm" Dense="true">
        <HeaderContent>
            <MudTh>ID</MudTh>
            <MudTh>Data</MudTh>
            <MudTh>Cliente</MudTh>
            <MudTh>Total</MudTh>
            <MudTh>Pago</MudTh>
            <MudTh>Faltante</MudTh>
            <MudTh>Status</MudTh>
            <MudTh>Ações</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="ID">#@context.Id</MudTd>
            <MudTd DataLabel="Data">@context.Data.ToString("dd/MM/yyyy")</MudTd>
            <MudTd DataLabel="Cliente">@context.Cliente</MudTd>
            <MudTd DataLabel="Total"><strong>@context.Total.ToString("N2") €</strong></MudTd>
            <MudTd DataLabel="Pago">
                <MudText Typo="Typo.body2" Color="Color.Success">@context.Pago.ToString("N2") €</MudText>
            </MudTd>
            <MudTd DataLabel="Faltante">
                <MudText Typo="Typo.body2" Color="Color.Error">@context.Faltante.ToString("N2") €</MudText>
            </MudTd>
            <MudTd DataLabel="Status">
                <MudChip T="string" Size="Size.Small" Color="Color.Warning">Pendente</MudChip>
            </MudTd>
            <MudTd DataLabel="Ações">
                <MudIconButton Icon="@Icons.Material.Filled.AttachMoney" Size="Size.Small" Color="Color.Success" OnClick="@(() => ReceberPagamento(context.Id))" />
                <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" Color="Color.Info" OnClick="@(() => VisualizarVenda(context.Id))" />
                <MudIconButton Icon="@Icons.Material.Filled.Print" Size="Size.Small" OnClick="@(() => ImprimirVenda(context.Id))" />
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText Typo="Typo.body1" Align="Align.Center" Class="py-8">
                <MudIcon Icon="@Icons.Material.Filled.Inbox" Size="Size.Large" Class="mb-2" />
                <br />
                Nenhuma venda pendente encontrada
            </MudText>
        </NoRecordsContent>
    </MudTable>

    <!-- Resumo -->
    <MudAlert Severity="Severity.Normal" Class="mt-6" NoIcon="true">
        <MudGrid>
            <MudItem xs="12" md="4">
                <MudText Typo="Typo.body2" Color="Color.Secondary">Total de Vendas Pendentes</MudText>
                <MudText Typo="Typo.h5">@vendasPendentes.Count</MudText>
            </MudItem>
            <MudItem xs="12" md="4">
                <MudText Typo="Typo.body2" Color="Color.Secondary">Total a Receber</MudText>
                <MudText Typo="Typo.h5" Color="Color.Primary">@totalReceber.ToString("N2") €</MudText>
            </MudItem>
            <MudItem xs="12" md="4">
                <MudText Typo="Typo.body2" Color="Color.Secondary">Já Recebido</MudText>
                <MudText Typo="Typo.h5" Color="Color.Success">@totalRecebido.ToString("N2") €</MudText>
            </MudItem>
        </MudGrid>
    </MudAlert>
</MudPaper>

@code {
    private string searchTerm = "";
    private DateTime? dataInicial = DateTime.Now.AddMonths(-1);
    private DateTime? dataFinal = DateTime.Now;
    private List<VendaPendenteDto> vendasPendentes = new();
    private decimal totalReceber = 0;
    private decimal totalRecebido = 0;

    protected override void OnInitialized()
    {
        // Exemplo de dados
        vendasPendentes = new List<VendaPendenteDto>
        {
            new VendaPendenteDto { Id = 1, Data = DateTime.Now.AddDays(-5), Cliente = "João Silva", Total = 500.00m, Pago = 200.00m, Faltante = 300.00m },
            new VendaPendenteDto { Id = 2, Data = DateTime.Now.AddDays(-3), Cliente = "Maria Santos", Total = 750.00m, Pago = 0, Faltante = 750.00m }
        };
        CalcularTotais();
    }

    private void Filtrar() { }
    private void ReceberPagamento(int vendaId) { }
    private void VisualizarVenda(int vendaId) { }
    private void ImprimirVenda(int vendaId) { }

    private void CalcularTotais()
    {
        totalReceber = vendasPendentes.Sum(v => v.Faltante);
        totalRecebido = vendasPendentes.Sum(v => v.Pago);
    }

    public class VendaPendenteDto
    {
        public int Id { get; set; }
        public DateTime Data { get; set; }
        public string Cliente { get; set; } = "";
        public decimal Total { get; set; }
        public decimal Pago { get; set; }
        public decimal Faltante { get; set; }
    }
}

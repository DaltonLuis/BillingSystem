@page "/venda/nova"
@rendermode InteractiveServer

<PageTitle>Nova Venda - Sistema de Faturação</PageTitle>

<MudText Typo="Typo.h4" Class="mb-2">Nova Venda</MudText>
<MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-6">Registre uma nova venda no sistema</MudText>

<MudPaper Elevation="2" Class="pa-6">
    <!-- Cliente Selection -->
    <MudGrid Class="mb-6">
        <MudItem xs="12" md="6">
            <MudSelect @bind-Value="selectedCliente" Label="Cliente" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Required="true">
                <MudSelectItem Value="@("")">Selecione um cliente</MudSelectItem>
                <MudSelectItem Value="@("1")">Cliente 1</MudSelectItem>
                <MudSelectItem Value="@("2")">Cliente 2</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="6">
            <MudDatePicker @bind-Date="dataVenda" Label="Data da Venda" Variant="Variant.Outlined" Required="true" />
        </MudItem>
    </MudGrid>

    <!-- Produtos Section -->
    <MudDivider Class="my-6" />
    <div class="d-flex justify-space-between align-center mb-4">
        <MudText Typo="Typo.h6">Produtos</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="AdicionarProduto">
            Adicionar Produto
        </MudButton>
    </div>

    <MudTable Items="@produtos" Hover="true" Breakpoint="Breakpoint.Sm" Dense="true" Class="mb-6">
        <HeaderContent>
            <MudTh>Produto</MudTh>
            <MudTh>Quantidade</MudTh>
            <MudTh>Preço Unit.</MudTh>
            <MudTh>Subtotal</MudTh>
            <MudTh>Ações</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Produto">
                <MudSelect T="string" Variant="Variant.Outlined" Dense="true" Margin="Margin.Dense">
                    <MudSelectItem Value="@("")">Selecione um produto</MudSelectItem>
                </MudSelect>
            </MudTd>
            <MudTd DataLabel="Quantidade">
                <MudNumericField @bind-Value="@quantidadePadrao" Min="1" Variant="Variant.Outlined" Margin="Margin.Dense" HideSpinButtons="true" />
            </MudTd>
            <MudTd DataLabel="Preço Unit.">
                <MudNumericField @bind-Value="@precoPadrao" Min="0" Step="0.01m" Variant="Variant.Outlined" Margin="Margin.Dense" HideSpinButtons="true" />
            </MudTd>
            <MudTd DataLabel="Subtotal"><strong>0,00 €</strong></MudTd>
            <MudTd DataLabel="Ações">
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => RemoverProduto(context))" />
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText Typo="Typo.body1" Align="Align.Center" Class="py-8">
                <MudIcon Icon="@Icons.Material.Filled.Inventory" Size="Size.Large" Class="mb-2" />
                <br />
                Nenhum produto adicionado
            </MudText>
        </NoRecordsContent>
    </MudTable>

    <!-- Totais -->
    <MudAlert Severity="Severity.Normal" Class="mb-6" NoIcon="true">
        <MudGrid>
            <MudItem xs="12" md="4">
                <MudText Typo="Typo.body2" Color="Color.Secondary">Subtotal</MudText>
                <MudText Typo="Typo.h5">@subtotal.ToString("N2") €</MudText>
            </MudItem>
            <MudItem xs="12" md="4">
                <MudText Typo="Typo.body2" Color="Color.Secondary">Desconto</MudText>
                <MudNumericField @bind-Value="desconto" Min="0" Step="0.01m" Variant="Variant.Outlined" HideSpinButtons="true" />
            </MudItem>
            <MudItem xs="12" md="4">
                <MudText Typo="Typo.body2" Color="Color.Secondary">Total</MudText>
                <MudText Typo="Typo.h4" Color="Color.Primary">@((subtotal - desconto).ToString("N2")) €</MudText>
            </MudItem>
        </MudGrid>
    </MudAlert>

    <!-- Forma de Pagamento -->
    <MudGrid Class="mb-6">
        <MudItem xs="12" md="6">
            <MudSelect @bind-Value="formaPagamento" Label="Forma de Pagamento" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Required="true">
                <MudSelectItem Value="@("")">Selecione</MudSelectItem>
                <MudSelectItem Value="@("dinheiro")">Dinheiro</MudSelectItem>
                <MudSelectItem Value="@("cartao")">Cartão</MudSelectItem>
                <MudSelectItem Value="@("transferencia")">Transferência</MudSelectItem>
                <MudSelectItem Value="@("multicaixa")">Multicaixa</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="6">
            <MudSelect @bind-Value="situacao" Label="Situação" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Required="true">
                <MudSelectItem Value="@("")">Selecione</MudSelectItem>
                <MudSelectItem Value="@("pago")">Pago</MudSelectItem>
                <MudSelectItem Value="@("pendente")">Pendente</MudSelectItem>
                <MudSelectItem Value="@("parcial")">Parcialmente Pago</MudSelectItem>
            </MudSelect>
        </MudItem>
    </MudGrid>

    <!-- Observações -->
    <MudTextField @bind-Value="observacoes" Label="Observações" Variant="Variant.Outlined" Lines="4" Placeholder="Digite observações sobre a venda..." Class="mb-6" />

    <!-- Botões de Ação -->
    <div class="d-flex justify-end gap-4">
        <MudButton Variant="Variant.Text" OnClick="Cancelar">Cancelar</MudButton>
        <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="SalvarRascunho">Salvar Rascunho</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="FinalizarVenda">Finalizar Venda</MudButton>
    </div>
</MudPaper>

@code {
    private string selectedCliente = "";
    private DateTime? dataVenda = DateTime.Now;
    private List<object> produtos = new();
    private decimal subtotal = 0;
    private decimal desconto = 0;
    private string formaPagamento = "";
    private string situacao = "";
    private string observacoes = "";
    private int quantidadePadrao = 1;
    private decimal precoPadrao = 0;

    private void AdicionarProduto()
    {
        produtos.Add(new object());
    }

    private void RemoverProduto(object produto)
    {
        produtos.Remove(produto);
    }

    private void Cancelar() { }
    private void SalvarRascunho() { }
    private void FinalizarVenda() { }
}
